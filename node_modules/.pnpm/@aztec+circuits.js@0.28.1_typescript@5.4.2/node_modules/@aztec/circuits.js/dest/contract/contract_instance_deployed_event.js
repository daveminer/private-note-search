import { AztecAddress } from '@aztec/foundation/aztec-address';
import { toBigIntBE } from '@aztec/foundation/bigint-buffer';
import { EthAddress } from '@aztec/foundation/eth-address';
import { Fr } from '@aztec/foundation/fields';
import { BufferReader } from '@aztec/foundation/serialize';
import { DEPLOYER_CONTRACT_INSTANCE_DEPLOYED_MAGIC_VALUE } from '../constants.gen.js';
/** Event emitted from the ContractInstanceDeployer. */
export class ContractInstanceDeployedEvent {
    constructor(address, version, salt, contractClassId, initializationHash, portalContractAddress, publicKeysHash, universalDeploy) {
        this.address = address;
        this.version = version;
        this.salt = salt;
        this.contractClassId = contractClassId;
        this.initializationHash = initializationHash;
        this.portalContractAddress = portalContractAddress;
        this.publicKeysHash = publicKeysHash;
        this.universalDeploy = universalDeploy;
    }
    static isContractInstanceDeployedEvent(log) {
        return toBigIntBE(log.subarray(0, 32)) == DEPLOYER_CONTRACT_INSTANCE_DEPLOYED_MAGIC_VALUE;
    }
    // TODO(@spalladino) We should be loading the singleton address from protocol-contracts,
    // but the protocol-contracts package depends on this one, and we cannot have circular dependencies,
    // hence we require it as an argument for now.
    static fromLogs(logs, instanceDeployerAddress) {
        return logs
            .filter(log => ContractInstanceDeployedEvent.isContractInstanceDeployedEvent(log.data))
            .filter(log => log.contractAddress.equals(instanceDeployerAddress))
            .map(log => ContractInstanceDeployedEvent.fromLogData(log.data));
    }
    static fromLogData(log) {
        if (!this.isContractInstanceDeployedEvent(log)) {
            const magicValue = DEPLOYER_CONTRACT_INSTANCE_DEPLOYED_MAGIC_VALUE.toString(16);
            throw new Error(`Log data for ContractInstanceDeployedEvent is not prefixed with magic value 0x${magicValue}`);
        }
        const reader = new BufferReader(log.subarray(32));
        const address = reader.readObject(AztecAddress);
        const version = reader.readObject(Fr).toNumber();
        const salt = reader.readObject(Fr);
        const contractClassId = reader.readObject(Fr);
        const initializationHash = reader.readObject(Fr);
        const portalContractAddress = EthAddress.fromField(reader.readObject(Fr));
        const publicKeysHash = reader.readObject(Fr);
        const universalDeploy = reader.readObject(Fr).toBool();
        return new ContractInstanceDeployedEvent(address, version, salt, contractClassId, initializationHash, portalContractAddress, publicKeysHash, universalDeploy);
    }
    toContractInstance() {
        if (this.version !== 1) {
            throw new Error(`Unexpected contract instance version ${this.version}`);
        }
        return {
            address: this.address,
            version: this.version,
            contractClassId: this.contractClassId,
            initializationHash: this.initializationHash,
            portalContractAddress: this.portalContractAddress,
            publicKeysHash: this.publicKeysHash,
            salt: this.salt,
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udHJhY3RfaW5zdGFuY2VfZGVwbG95ZWRfZXZlbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi9zcmMvY29udHJhY3QvY29udHJhY3RfaW5zdGFuY2VfZGVwbG95ZWRfZXZlbnQudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLGlDQUFpQyxDQUFDO0FBQy9ELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxpQ0FBaUMsQ0FBQztBQUM3RCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sK0JBQStCLENBQUM7QUFDM0QsT0FBTyxFQUFFLEVBQUUsRUFBRSxNQUFNLDBCQUEwQixDQUFDO0FBQzlDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSw2QkFBNkIsQ0FBQztBQUczRCxPQUFPLEVBQUUsK0NBQStDLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQztBQUV0Rix1REFBdUQ7QUFDdkQsTUFBTSxPQUFPLDZCQUE2QjtJQUN4QyxZQUNrQixPQUFxQixFQUNyQixPQUFlLEVBQ2YsSUFBUSxFQUNSLGVBQW1CLEVBQ25CLGtCQUFzQixFQUN0QixxQkFBaUMsRUFDakMsY0FBa0IsRUFDbEIsZUFBd0I7UUFQeEIsWUFBTyxHQUFQLE9BQU8sQ0FBYztRQUNyQixZQUFPLEdBQVAsT0FBTyxDQUFRO1FBQ2YsU0FBSSxHQUFKLElBQUksQ0FBSTtRQUNSLG9CQUFlLEdBQWYsZUFBZSxDQUFJO1FBQ25CLHVCQUFrQixHQUFsQixrQkFBa0IsQ0FBSTtRQUN0QiwwQkFBcUIsR0FBckIscUJBQXFCLENBQVk7UUFDakMsbUJBQWMsR0FBZCxjQUFjLENBQUk7UUFDbEIsb0JBQWUsR0FBZixlQUFlLENBQVM7SUFDdkMsQ0FBQztJQUVKLE1BQU0sQ0FBQywrQkFBK0IsQ0FBQyxHQUFXO1FBQ2hELE9BQU8sVUFBVSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLElBQUksK0NBQStD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